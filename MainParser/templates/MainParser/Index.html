{% extends 'MainParser/base.html' %}

{% load static %}

{% block content %}



{% if user.is_authenticated %}
<h2 style="margin-top: 150px; text-align: center;"> {{ name }}</h2>
<div style="text-align: center">
    {% if work_status %}
        <button id="working_button" onclick="working_status()"> Working </button>
    {% else %}
        <button id="working_button" onclick="working_status()"> Not working </button>
    {% endif %}
</div>
{% endif %}

<table style="margin-top: 20px; width: 95%; margin-left: 2.5%;" id="mainTable">
</table>

<script>
    let focused = '-1';
    let table = $("table");
    let head_title = "<thead><th>Время</th><th>Площадка</th><th>Название</th><th>Адрес</th><th>Цена</th><th>Телефон</th>";
    head_title += "<th>Город</th><th>Опрос</th><th>Закрыл</th><th>Позвонить</th><th>Пользователь</th><th>Ссылка</th><th>Сделано</th></thead>"
    table.append(head_title);
    var update = function () {
        $.ajax({
            url: "{% url 'ajax-get_table' %}",
            dataType: 'json',
            success: function (data) {
                let table_tr = $("table tr");
                if (table_tr.length === 1) {
                    for (let i = 0; i < data['respond'].length; i++) {
                        let ad = data['respond'][i];
                        table.append(addNote(ad));
                    }
                    return 'ok';
                }
                else{
                    let head = table_tr[1];
                    for (let i = 0; i < data['respond'].length; i++){
                        let ad = data['respond'][i];
                        if (parseInt(ad['id']) > parseInt(head.id)){
                            $(addNote(ad)).insertBefore(head);
                        }
                        else{
                            let color = getColor(ad);
                            let tr = $('#' + ad['id']);
                            if (tr.css("background-color") !== color) {
                                changeTrColor(ad['id'], color)
                            }

                            // Call status
                            let call_status = "";
                            let call_button = tr[0].cells[7].childNodes[0];

                            if (ad['noCall'] === true)
                                call_status = "no call";
                            else
                                call_status = "call";

                            if (call_button.innerHTML !== call_status)
                                call_button.innerHTML = call_status;


                            // Close status
                            let close_status = "";
                            let close_button = tr[0].cells[8].childNodes[0];


                            if (ad['frontDone'] === true)
                                close_status = "закрыл";
                            else
                                close_status = "не закрыл";

                            if (close_button.innerHTML !== close_status)
                                close_button.innerHTML = close_status;

                            // Person status
                            let person_text = tr[0].cells[10];

                            if (person_text.innerHTML !== ad['person'])
                                person_text.innerHTML = ad['person'];

                            // Done
                            let done_text = tr[0].cells[12];
                            let done_status = "";

                            if (ad['done'] === true)
                                done_status = "✔";
                            else
                                done_status = "";

                            if (done_text.innerHTML !== done_status)
                                done_text.innerHTML = done_status;

                        }
                    }
                }
            }
        });
    };

    const getColor = function (ad){
        let color = "rgb(0, 0, 0)"
        if (ad['id'] == focused)
            color = "rgb(0, 128, 0)";
        else if (ad['color'] === 'gray')
            color = "rgb(240, 240, 240)";
        else if (ad['color'] === 'orange')
            color = 'rgb(255, 165, 0)';
        else if (ad['color'] === 'blue')
            color = 'rgb(0, 0, 255)';
        return color;
    }

    const addNote = function (ad){
        let color = getColor(ad);

        let new_data = "<tr style='background-color: " + color + "' id='" + ad['id'] +"'>"
        new_data += "<th style='background-color: " + color + "'><button onclick='focus_ad(" + ad['id'] + ")'>" +  ad['date'] + "</button></th>";
        new_data += "<th style='background-color: " + color + "'>" + ad['site'] + "</th>";
        new_data += "<th style='background-color: " + color + "'>" + ad['title'] + "</th>";
        new_data += "<th style='background-color: " + color + "'>" + ad['address'] + "</th>";
        new_data += "<th style='background-color: " + color + "'>" + ad['price'] + "</th>";
        new_data += "<th style='background-color: " + color + "'>" + ad['phone'] + "</th>";
        new_data += "<th style='background-color: " + color + "'>" + ad['city'] + "</th>";

        new_data += "<th style='background-color: " + color + "'><button onclick='noCall(" + ad['id'] + ")'>"
        if (ad['noCall'] === true)
            new_data += "no call"
        else
            new_data += "call"
        new_data += "</button></th>";

        new_data += "<th style='background-color: " + color + "'><button onclick='closed(" + ad['id'] + ")'>"
        if (ad['frontDone'] === true)
            new_data += "закрыл";
        else
            new_data += "не закрыл"
        new_data += "</button></th>";

        new_data += "<th style='background-color: " + color + "'><button onclick='targetAd(" + ad['id'] + ")'> ☎ </button></th>";

        new_data += "<th style='background-color: " + color + "'>" + ad['person'] + "</th>";
        new_data += "<th style='background-color: " + color + "'><a href=\"https://avito.ru/" + ad['link'] + "\">Перейти на сайт</a></th>";
        if (ad['done'] === true)
            new_data += "<th style='background-color: " + color + "'>✔</th>";
        else
            new_data += "<th style='background-color: " + color + "'></th>";
        new_data += "</tr>";
        return new_data;
    }

    const targetAd = function (id) {
        $.ajax({
            url: "{% url 'ajax-target_ad' %}",
            data: {'id': id},
            dataType: 'json',
            success: function (data) {
                console.log(data);
            }
        });
    };

    const noCall = function (id) {
        let tr = $('#' + id.toString());
        let call_button = tr[0].cells[7].childNodes[0];
        if (call_button.innerHTML === "call")
            call_button.innerHTML = "no call";
        else
            call_button.innerHTML = "call";

        $.ajax({
            url: "{% url 'ajax-no_call' %}",
            data: {'id': id},
            dataType: 'json',
            success: function (data) {
                console.log(data);
            }
        });
    };

    const closed = function (id) {
        let tr = $('#' + id.toString());
        let close_button = tr[0].cells[8].childNodes[0];

        if (close_button.innerHTML === "закрыл")
            close_button.innerHTML = "не закрыл"
        else
            close_button.innerHTML = "закрыл";

        $.ajax({
            url: "{% url 'ajax-closed' %}",
            data: {'id': id},
            dataType: 'json',
            success: function (data) {
                console.log(data);
            }
        });
    }

    const focus_ad = function (id) {
        if (id == focused) {
            focused = -1;
            changeTrColor(id.toString(), "rgb(240, 240, 240)");
        }
        else if (focused != -1) {
            changeTrColor(focused, "rgb(240, 240, 240)");
            focused = id;
            changeTrColor(id.toString(), "rgb(0, 128, 0)");
        }
        else{
            focused = id;
            changeTrColor(id.toString(), "rgb(0, 128, 0)");
        }

    }

    const changeTrColor = function (id, color){
        let tr = $('#' + id);
        tr.css({'background-color': color});
        let ths = tr[0].cells;
        for (let j = 0; j < ths.length; j++)
            ths[j].style.backgroundColor = color;
    }

    const working_status = function () {
        $.ajax({
            url: "{% url 'ajax-working_status' %}",
            dataType: 'json',
            success: function (data) {
                if (data['work'] === true)
                    document.getElementById('working_button').innerText = 'Working';
                else
                    document.getElementById('working_button').innerText = 'Not working';
                console.log(data);
            }
        });
    }
    update();
    setInterval(update, 200);
</script>


{% endblock %}

